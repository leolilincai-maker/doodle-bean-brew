<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>产品介绍 - 豆豆谷</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <nav class="container">
            <a href="index.html" class="logo">
                <img src="images/logo.jpg" alt="豆豆谷 Doodle Bean Brew">
            </a>
            <ul class="nav-links">
                <li><a href="index.html">首页</a></li>
                <li><a href="products.html" class="active">产品介绍</a></li>
                <li><a href="ingredients.html">原料介绍</a></li>
                <li><a href="contact.html">联系我们</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <section class="hero">
            <div class="container">
                <div class="hero-content">
                    <h1>我们的饮品</h1>
                    <p>精心调配的豆类与花卉饮品，每一杯都是健康与美味的完美平衡</p>
                </div>
            </div>
        </section>

        <section class="section">
            <div class="container">
                <h2 class="section-title">🔥 热饮系列 Hot Drinks</h2>
                <div class="product-grid">
                    <!-- 招牌产品：红粉豆语 -->
                    <div class="product-card featured">
                        <div class="product-badge">🏆 招牌推荐</div>
                        <div class="product-image">
                            <img src="images/Hongfendouyu.JPG.jpg" alt="红粉豆语 - 豆豆谷招牌饮品" class="product-photo">
                        </div>
                        <div class="product-info">
                            <h3 class="product-name">红粉豆语 Signature Blend</h3>
                            <p class="product-description">豆豆谷招牌之作！精选黄豆与红豆黄金比例调配，融入天然玫瑰花瓣。富含植物蛋白与膳食纤维，每一口都是丝绸般的温暖呵护，带来日常元气与轻盈注入。</p>
                            <div class="product-highlights">
                                <span class="highlight">🌟 招牌特调</span>
                                <span class="highlight">🌹 玫瑰花瓣</span>
                                <span class="highlight">💖 美颜功效</span>
                            </div>
                            <div class="product-price" id="signaturePrice">S$7.80</div>
                            
                            <!-- 产品定制选项 -->
                            <div class="product-options">
                                <!-- 杯型选择 -->
                                <div class="option-group">
                                    <label class="option-label">杯型:</label>
                                    <div class="option-buttons">
                                        <button type="button" class="option-btn" onclick="selectSize('signature', 'large', 7.80)">
                                            大杯
                                        </button>
                                        <button type="button" class="option-btn" onclick="selectSize('signature', 'small', 6.80)">
                                            小杯
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- 温度选择 -->
                                <div class="option-group">
                                    <label class="option-label">温度:</label>
                                    <div class="option-buttons">
                                        <button type="button" class="option-btn" onclick="selectTemperature('signature', 'hot')">
                                            🔥 热饮
                                        </button>
                                        <button type="button" class="option-btn" onclick="selectTemperature('signature', 'cold')">
                                            🧊 冰饮
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- 糖分选择 -->
                                <div class="option-group">
                                    <label class="option-label">糖分:</label>
                                    <div class="option-buttons">
                                        <button type="button" class="option-btn" onclick="selectSugar('signature', 'none')">
                                            无糖
                                        </button>
                                        <button type="button" class="option-btn" onclick="selectSugar('signature', 'half')">
                                            半糖
                                        </button>
                                        <button type="button" class="option-btn" onclick="selectSugar('signature', 'standard')">
                                            标准糖
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 数量选择 -->
                            <div class="quantity-selector">
                                <label for="signatureQuantity">数量:</label>
                                <div class="quantity-controls">
                                    <button type="button" onclick="changeQuantity('signatureQuantity', -1)">-</button>
                                    <input type="number" id="signatureQuantity" value="1" min="1" max="10" readonly>
                                    <button type="button" onclick="changeQuantity('signatureQuantity', 1)">+</button>
                                </div>
                            </div>
                            
                            <div class="order-buttons">
                                <button class="order-btn cart-btn" onclick="addSignatureToCart('signature')">
                                    🛒 加入购物车
                                </button>
                                <button class="order-btn whatsapp-btn" onclick="orderSignatureProduct('signature')">
                                    📱 立即订购
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 新产品：桂花双豆奶 -->
                    <div class="product-card featured">
                        <div class="product-badge">🌟 全新推出</div>
                        <div class="product-image">
                            <img src="images/huangdoulvdouguihua.jpg" alt="桂花双豆奶 - 黄豆绿豆桂花完美融合" class="product-photo">
                        </div>
                        <div class="product-info">
                            <h3 class="product-name">桂花双豆奶 Golden Bean Harmony</h3>
                            <p class="product-description">精选黄豆与绿豆双重营养精华，融入天然桂花香甜。双豆搭配带来丰富蛋白质与膳食纤维，桂花增添自然甜香，口感醇厚，层次丰富，是健康与美味的完美结合。</p>
                            <div class="product-highlights">
                                <span class="highlight">🌟 双豆精华</span>
                                <span class="highlight">🌼 桂花芬芳</span>
                                <span class="highlight">💚 健康营养</span>
                            </div>
                            <div class="product-price" id="guihuaPrice">S$7.20</div>
                            
                            <!-- 产品定制选项 -->
                            <div class="product-options">
                                <!-- 杯型选择 -->
                                <div class="option-group">
                                    <label class="option-label">杯型:</label>
                                    <div class="option-buttons">
                                        <button type="button" class="option-btn" onclick="selectSize('guihua', 'large', 7.20)">
                                            大杯
                                        </button>
                                        <button type="button" class="option-btn" onclick="selectSize('guihua', 'small', 6.20)">
                                            小杯
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- 温度选择 -->
                                <div class="option-group">
                                    <label class="option-label">温度:</label>
                                    <div class="option-buttons">
                                        <button type="button" class="option-btn" onclick="selectTemperature('guihua', 'hot')">
                                            🔥 热饮
                                        </button>
                                        <button type="button" class="option-btn" onclick="selectTemperature('guihua', 'cold')">
                                            🧊 冰饮
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- 糖分选择 -->
                                <div class="option-group">
                                    <label class="option-label">糖分:</label>
                                    <div class="option-buttons">
                                        <button type="button" class="option-btn" onclick="selectSugar('guihua', 'none')">
                                            无糖
                                        </button>
                                        <button type="button" class="option-btn" onclick="selectSugar('guihua', 'half')">
                                            半糖
                                        </button>
                                        <button type="button" class="option-btn" onclick="selectSugar('guihua', 'standard')">
                                            标准糖
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 数量选择 -->
                            <div class="quantity-selector">
                                <label for="guihuaQuantity">数量:</label>
                                <div class="quantity-controls">
                                    <button type="button" onclick="changeQuantity('guihuaQuantity', -1)">-</button>
                                    <input type="number" id="guihuaQuantity" value="1" min="1" max="10" readonly>
                                    <button type="button" onclick="changeQuantity('guihuaQuantity', 1)">+</button>
                                </div>
                            </div>
                            
                            <div class="order-buttons">
                                <button class="order-btn cart-btn" onclick="addSignatureToCart('guihua')">
                                    🛒 加入购物车
                                </button>
                                <button class="order-btn whatsapp-btn" onclick="orderSignatureProduct('guihua')">
                                    📱 立即订购
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="product-card">
                        <div class="product-image">🌹</div>
                        <div class="product-info">
                            <h3 class="product-name">玫瑰红豆拿铁</h3>
                            <p class="product-description">优质红豆研磨制作，加入新鲜玫瑰花瓣，口感香甜。具有补血养颜、美容护肤的功效。</p>
                            <div class="product-price">S$7.50</div>
                            
                            <!-- 数量选择 -->
                            <div class="quantity-selector">
                                <label for="quantity2">数量:</label>
                                <div class="quantity-controls">
                                    <button type="button" onclick="changeQuantity('quantity2', -1)">-</button>
                                    <input type="number" id="quantity2" value="1" min="1" max="10" readonly>
                                    <button type="button" onclick="changeQuantity('quantity2', 1)">+</button>
                                </div>
                            </div>
                            
                            <div class="order-buttons">
                                <button class="order-btn cart-btn" onclick="addToCart('玫瑰红豆拿铁', 'S$7.50', '🌹', 'quantity2')">
                                    🛒 加入购物车
                                </button>
                                <button class="order-btn whatsapp-btn" onclick="startDeliveryVerification('whatsapp', '玫瑰红豆拿铁', 'S$7.50')">
                                    📱 立即订购
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 新产品：洛神四宝饮 -->
                    <div class="product-card featured">
                        <div class="product-badge">🌟 全新推出</div>
                        <div class="product-image">
                            <img src="images/heidouhongdouluoshenhuahongzao.jpg" alt="洛神四宝饮 - 黑豆红豆洛神花红枣养颜佳品" class="product-photo">
                        </div>
                        <div class="product-info">
                            <h3 class="product-name">洛神四宝饮 Beauty Quartet</h3>
                            <p class="product-description">珍贵四重配方：黑豆红豆双豆营养基底，洛神花酸甜回甘，红枣温润补血。四宝合一，具有美容养颜、补血益气、抗氧化等多重功效，是现代都市女性的养颜美容圣品。</p>
                            <div class="product-highlights">
                                <span class="highlight">💖 美颜圣品</span>
                                <span class="highlight">🌺 洛神花香</span>
                                <span class="highlight">🔥 四宝精华</span>
                                <span class="highlight">🩸 补血益气</span>
                            </div>
                            <div class="product-price" id="luoshenPrice">S$8.50</div>
                            
                            <!-- 产品定制选项 -->
                            <div class="product-options">
                                <!-- 杯型选择 -->
                                <div class="option-group">
                                    <label class="option-label">杯型:</label>
                                    <div class="option-buttons">
                                        <button type="button" class="option-btn" onclick="selectSize('luoshen', 'large', 8.50)">
                                            大杯
                                        </button>
                                        <button type="button" class="option-btn" onclick="selectSize('luoshen', 'small', 7.50)">
                                            小杯
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- 温度选择 -->
                                <div class="option-group">
                                    <label class="option-label">温度:</label>
                                    <div class="option-buttons">
                                        <button type="button" class="option-btn" onclick="selectTemperature('luoshen', 'hot')">
                                            🔥 热饮
                                        </button>
                                        <button type="button" class="option-btn" onclick="selectTemperature('luoshen', 'cold')">
                                            🧊 冰饮
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- 糖分选择 -->
                                <div class="option-group">
                                    <label class="option-label">糖分:</label>
                                    <div class="option-buttons">
                                        <button type="button" class="option-btn" onclick="selectSugar('luoshen', 'none')">
                                            无糖
                                        </button>
                                        <button type="button" class="option-btn" onclick="selectSugar('luoshen', 'half')">
                                            半糖
                                        </button>
                                        <button type="button" class="option-btn" onclick="selectSugar('luoshen', 'standard')">
                                            标准糖
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 数量选择 -->
                            <div class="quantity-selector">
                                <label for="luoshenQuantity">数量:</label>
                                <div class="quantity-controls">
                                    <button type="button" onclick="changeQuantity('luoshenQuantity', -1)">-</button>
                                    <input type="number" id="luoshenQuantity" value="1" min="1" max="10" readonly>
                                    <button type="button" onclick="changeQuantity('luoshenQuantity', 1)">+</button>
                                </div>
                            </div>
                            
                            <div class="order-buttons">
                                <button class="order-btn cart-btn" onclick="addSignatureToCart('luoshen')">
                                    🛒 加入购物车
                                </button>
                                <button class="order-btn whatsapp-btn" onclick="orderSignatureProduct('luoshen')">
                                    📱 立即订购
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="section bg-pattern">
            <div class="container">
                <h2 class="section-title">🧊 冷饮系列</h2>
                <div class="product-grid">
                    <!-- 新产品：茉莉双豆语 -->
                    <div class="product-card featured">
                        <div class="product-badge">🌟 全新推出</div>
                        <div class="product-image">
                            <img src="images/heidoulvdoumolihua.jpg" alt="茉莉双豆语 - 黑豆绿豆茉莉花清香融合" class="product-photo">
                        </div>
                        <div class="product-info">
                            <h3 class="product-name">茉莉双豆语 Jasmine Twin Beans</h3>
                            <p class="product-description">黑豆与绿豆的营养双重奏，配以清香茉莉花香。黑豆富含花青素，绿豆清热解毒，茉莉花舒缓怡神，口感清新淡雅，具有清热解毒、美容养颜的功效，是夏日清爽的完美选择。</p>
                            <div class="product-highlights">
                                <span class="highlight">🌿 清热解毒</span>
                                <span class="highlight">🌸 茉莉清香</span>
                                <span class="highlight">💚 双豆精华</span>
                                <span class="highlight">❄️ 清爽怡人</span>
                            </div>
                            <div class="product-price" id="moliPrice">S$6.80</div>
                            
                            <!-- 产品定制选项 -->
                            <div class="product-options">
                                <!-- 杯型选择 -->
                                <div class="option-group">
                                    <label class="option-label">杯型:</label>
                                    <div class="option-buttons">
                                        <button type="button" class="option-btn" onclick="selectSize('moli', 'large', 6.80)">
                                            大杯
                                        </button>
                                        <button type="button" class="option-btn" onclick="selectSize('moli', 'small', 5.80)">
                                            小杯
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- 温度选择 -->
                                <div class="option-group">
                                    <label class="option-label">温度:</label>
                                    <div class="option-buttons">
                                        <button type="button" class="option-btn" onclick="selectTemperature('moli', 'hot')">
                                            🔥 热饮
                                        </button>
                                        <button type="button" class="option-btn" onclick="selectTemperature('moli', 'cold')">
                                            🧊 冰饮
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- 糖分选择 -->
                                <div class="option-group">
                                    <label class="option-label">糖分:</label>
                                    <div class="option-buttons">
                                        <button type="button" class="option-btn" onclick="selectSugar('moli', 'none')">
                                            无糖
                                        </button>
                                        <button type="button" class="option-btn" onclick="selectSugar('moli', 'half')">
                                            半糖
                                        </button>
                                        <button type="button" class="option-btn" onclick="selectSugar('moli', 'standard')">
                                            标准糖
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 数量选择 -->
                            <div class="quantity-selector">
                                <label for="moliQuantity">数量:</label>
                                <div class="quantity-controls">
                                    <button type="button" onclick="changeQuantity('moliQuantity', -1)">-</button>
                                    <input type="number" id="moliQuantity" value="1" min="1" max="10" readonly>
                                    <button type="button" onclick="changeQuantity('moliQuantity', 1)">+</button>
                                </div>
                            </div>
                            
                            <div class="order-buttons">
                                <button class="order-btn cart-btn" onclick="addSignatureToCart('moli')">
                                    🛒 加入购物车
                                </button>
                                <button class="order-btn whatsapp-btn" onclick="orderSignatureProduct('moli')">
                                    📱 立即订购
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="product-card">
                        <div class="product-image">🌸</div>
                        <div class="product-info">
                            <h3 class="product-name">樱花豌豆冰茶</h3>
                            <p class="product-description">颜值担当！粉嫩樱花配上清香豌豆，视觉与味觉的双重享受。</p>
                            <div class="product-price">S$8.50</div>
                            
                            <!-- 数量选择 -->
                            <div class="quantity-selector">
                                <label for="quantity5">数量:</label>
                                <div class="quantity-controls">
                                    <button type="button" onclick="changeQuantity('quantity5', -1)">-</button>
                                    <input type="number" id="quantity5" value="1" min="1" max="10" readonly>
                                    <button type="button" onclick="changeQuantity('quantity5', 1)">+</button>
                                </div>
                            </div>
                            
                            <div class="order-buttons">
                                <button class="order-btn cart-btn" onclick="addToCart('樱花豌豆冰茶', 'S$8.50', '🌸', 'quantity5')">
                                    🛒 加入购物车
                                </button>
                                <button class="order-btn whatsapp-btn" onclick="startDeliveryVerification('whatsapp', '樱花豌豆冰茶', 'S$8.50')">
                                    📱 立即订购
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="product-card">
                        <div class="product-image">💜</div>
                        <div class="product-info">
                            <h3 class="product-name">薰衣草红豆奶昔</h3>
                            <p class="product-description">浪漫薰衣草香与红豆的甜蜜结合，具有安神助眠的功效。</p>
                            <div class="product-price">S$8.20</div>
                            
                            <!-- 数量选择 -->
                            <div class="quantity-selector">
                                <label for="quantity6">数量:</label>
                                <div class="quantity-controls">
                                    <button type="button" onclick="changeQuantity('quantity6', -1)">-</button>
                                    <input type="number" id="quantity6" value="1" min="1" max="10" readonly>
                                    <button type="button" onclick="changeQuantity('quantity6', 1)">+</button>
                                </div>
                            </div>
                            
                            <div class="order-buttons">
                                <button class="order-btn cart-btn" onclick="addToCart('薰衣草红豆奶昔', 'S$8.20', '💜', 'quantity6')">
                                    🛒 加入购物车
                                </button>
                                <button class="order-btn whatsapp-btn" onclick="startDeliveryVerification('whatsapp', '薰衣草红豆奶昔', 'S$8.20')">
                                    📱 立即订购
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- 购物车悬浮图标 -->
    <div id="cartFloat" class="cart-float" onclick="openCart()">
        <div class="cart-icon">🛒</div>
        <div id="cartCount" class="cart-count">0</div>
        <div id="cartTotal" class="cart-total">S$0.00</div>
    </div>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div>
                    <p>&copy; 2024 豆豆谷 Doodle Bean Brew. 保留所有权利</p>
                </div>
                <div class="social-links">
                    <a href="#" title="微信">📱</a>
                    <a href="#" title="微博">🐦</a>
                    <a href="#" title="小红书">📖</a>
                    <a href="#" title="抖音">🎵</a>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // 全局变量
        let cart = JSON.parse(localStorage.getItem('doodleCart')) || [];
        let currentOrderData = null; // 购物车订单数据
        let currentPaymentData = null; // 当前支付订单数据
        
        // 初始化购物车显示
        function initCart() {
            updateCartDisplay();
        }
        
        // 数量控制
        function changeQuantity(inputId, change) {
            const input = document.getElementById(inputId);
            let currentValue = parseInt(input.value);
            let newValue = currentValue + change;
            
            if (newValue >= 1 && newValue <= 10) {
                input.value = newValue;
            }
        }
        
        // 添加到购物车
        function addToCart(name, price, emoji, quantityId) {
            const quantity = parseInt(document.getElementById(quantityId).value);
            const priceNum = parseFloat(price.replace('S$', ''));
            
            // 检查是否已存在相同产品
            const existingItem = cart.find(item => item.name === name);
            
            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                cart.push({
                    name: name,
                    price: priceNum,
                    emoji: emoji,
                    quantity: quantity
                });
            }
            
            // 保存到localStorage
            localStorage.setItem('doodleCart', JSON.stringify(cart));
            
            // 更新显示
            updateCartDisplay();
            
            // 重置数量为1
            document.getElementById(quantityId).value = 1;
            
            // 显示添加成功提示
            showAddToCartSuccess(name, quantity);
        }
        
        // 显示添加成功提示
        function showAddToCartSuccess(name, quantity) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--primary-color);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                z-index: 10001;
                transform: translateX(100%);
                transition: transform 0.3s ease;
            `;
            
            toast.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.2rem;">✅</span>
                    <div>
                        <div style="font-weight: bold;">${name}</div>
                        <div style="font-size: 0.9rem;">已添加 ${quantity} 份到购物车</div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // 动画显示
            setTimeout(() => {
                toast.style.transform = 'translateX(0)';
            }, 100);
            
            // 3秒后移除
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }
        
        // 更新购物车显示
        function updateCartDisplay() {
            const cartCount = document.getElementById('cartCount');
            const cartTotal = document.getElementById('cartTotal');
            const cartFloat = document.getElementById('cartFloat');
            
            if (cart.length === 0) {
                cartCount.textContent = '0';
                cartTotal.textContent = 'S$0.00';
                cartFloat.style.display = 'none';
                return;
            }
            
            // 计算总数量和总价
            const totalQuantity = cart.reduce((sum, item) => sum + item.quantity, 0);
            const totalPrice = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            cartCount.textContent = totalQuantity;
            cartTotal.textContent = `S$${totalPrice.toFixed(2)}`;
            cartFloat.style.display = 'flex';
        }
        
        // 打开购物车
        function openCart() {
            const modal = document.createElement('div');
            modal.className = 'cart-modal';
            modal.onclick = (e) => {
                if (e.target === modal) closeCart();
            };
            
            const content = document.createElement('div');
            content.className = 'cart-content';
            
            if (cart.length === 0) {
                content.innerHTML = `
                    <div class="cart-header">
                        <h3>🛒 购物车</h3>
                        <button class="modal-close" onclick="closeCart()">✕</button>
                    </div>
                    <div class="cart-empty">
                        <div class="cart-empty-icon">🛒</div>
                        <h3>购物车是空的</h3>
                        <p>快去选择您喜欢的豆豆谷饮品吧！</p>
                    </div>
                `;
            } else {
                const totalPrice = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const totalQuantity = cart.reduce((sum, item) => sum + item.quantity, 0);
                
                content.innerHTML = `
                    <div class="cart-header">
                        <h3>🛒 购物车 (${totalQuantity}件商品)</h3>
                        <button class="modal-close" onclick="closeCart()">✕</button>
                    </div>
                    <div class="cart-body">
                        ${cart.map((item, index) => `
                            <div class="cart-item">
                                <div class="cart-item-image">${item.emoji}</div>
                                <div class="cart-item-info">
                                    <div class="cart-item-name">${item.name}</div>
                                    <div class="cart-item-price">S$${item.price.toFixed(2)} x ${item.quantity} = S$${(item.price * item.quantity).toFixed(2)}</div>
                                </div>
                                <div class="cart-item-controls">
                                    <div class="cart-item-quantity">
                                        <button onclick="updateCartItemQuantity(${index}, -1)">-</button>
                                        <span>${item.quantity}</span>
                                        <button onclick="updateCartItemQuantity(${index}, 1)">+</button>
                                    </div>
                                    <button class="cart-remove-btn" onclick="removeCartItem(${index})">删除</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="cart-footer">
                        <div class="cart-summary">
                            <span>总计：</span>
                            <span style="color: var(--accent-color);">S$${totalPrice.toFixed(2)}</span>
                        </div>
                        <div class="cart-actions">
                            <button class="cart-checkout-btn" onclick="checkoutCart()">🛒 去订购</button>
                            <button class="cart-close-btn" onclick="closeCart()">继续购物</button>
                        </div>
                    </div>
                `;
            }
            
            modal.appendChild(content);
            document.body.appendChild(modal);
        }
        
        // 关闭购物车
        function closeCart() {
            const modal = document.querySelector('.cart-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        // 更新购物车商品数量
        function updateCartItemQuantity(index, change) {
            if (index >= 0 && index < cart.length) {
                cart[index].quantity += change;
                
                if (cart[index].quantity <= 0) {
                    cart.splice(index, 1);
                } else if (cart[index].quantity > 10) {
                    cart[index].quantity = 10;
                }
                
                localStorage.setItem('doodleCart', JSON.stringify(cart));
                updateCartDisplay();
                
                // 重新渲染购物车
                closeCart();
                openCart();
            }
        }
        
        // 删除购物车商品
        function removeCartItem(index) {
            if (index >= 0 && index < cart.length) {
                cart.splice(index, 1);
                localStorage.setItem('doodleCart', JSON.stringify(cart));
                updateCartDisplay();
                
                // 重新渲染购物车
                closeCart();
                openCart();
            }
        }
        
        // 购物车结算
        function checkoutCart() {
            if (cart.length === 0) {
                alert('购物车是空的！');
                return;
            }
            
            closeCart();
            
            // 生成购物车订单消息
            const orderItems = cart.map(item => 
                `${item.emoji} ${item.name} x${item.quantity} = S$${(item.price * item.quantity).toFixed(2)}`
            ).join('\n');
            
            const totalPrice = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const totalQuantity = cart.reduce((sum, item) => sum + item.quantity, 0);
            
            // 启动地址验证，传递购物车信息
            startCartDeliveryVerification(orderItems, totalPrice, totalQuantity);
        }
        
        // 购物车地址验证
        function startCartDeliveryVerification(orderItems, totalPrice, totalQuantity) {
            currentOrderData = { orderItems, totalPrice, totalQuantity };
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                backdrop-filter: blur(5px);
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                padding: 2rem;
                border-radius: 20px;
                max-width: 500px;
                width: 90%;
                text-align: center;
                box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                position: relative;
                max-height: 80vh;
                overflow-y: auto;
            `;
            
            content.innerHTML = `
                <h3 style="color: #6B8E7B; margin-bottom: 1rem;">🛒 确认订单 & 配送地址</h3>
                
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 10px; margin-bottom: 1.5rem; text-align: left;">
                    <h4 style="color: #333; margin-bottom: 0.5rem;">📋 订单详情：</h4>
                    <div style="font-size: 0.9rem; line-height: 1.6;">
                        ${orderItems.replace(/\n/g, '<br>')}
                    </div>
                    <hr style="margin: 1rem 0; border: none; border-top: 1px solid #ddd;">
                    <div style="font-weight: bold; color: var(--accent-color);">
                        总计：${totalQuantity}件商品，S$${totalPrice.toFixed(2)}
                    </div>
                </div>
                
                <div style="background: #e8f5e8; padding: 1rem; border-radius: 10px; margin-bottom: 1.5rem; text-align: left;">
                    <h4 style="color: #333; margin-bottom: 1rem;">✅ 免费配送区域：</h4>
                    <div style="margin-bottom: 1rem;">
                        <strong>🏠 West Terra @ Bukit Batok</strong><br>
                        <span style="color: #666;">Block 447, 448, 449, 450, 451, 452, 453</span><br>
                        <span style="color: #666;">Bukit Batok West Avenue 2/5</span>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <strong>🏢 Le Quest公寓</strong><br>
                        <span style="color: #666;">Bukit Batok West Avenue 6</span>
                    </div>
                    <div style="color: #E76F51; font-weight: bold;">
                        🚚 配送费用：完全免费<br>
                        ⏰ 配送时间：30-60分钟
                    </div>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #333;">请选择您的地址：</label>
                    <select id="cartAddressSelect" style="width: 100%; padding: 0.8rem; border: 2px solid #6B8E7B; border-radius: 10px; font-size: 1rem;">
                        <option value="">请选择您的具体地址...</option>
                        <optgroup label="🏠 West Terra @ Bukit Batok">
                            <option value="447">Block 447 Bukit Batok West Avenue</option>
                            <option value="448">Block 448 Bukit Batok West Avenue</option>
                            <option value="449">Block 449 Bukit Batok West Avenue</option>
                            <option value="450">Block 450 Bukit Batok West Avenue</option>
                            <option value="451">Block 451 Bukit Batok West Avenue</option>
                            <option value="452">Block 452 Bukit Batok West Avenue</option>
                            <option value="453">Block 453 Bukit Batok West Avenue</option>
                        </optgroup>
                        <optgroup label="🏢 Le Quest公寓">
                            <option value="lequest">Le Quest, Bukit Batok West Avenue 6</option>
                        </optgroup>
                        <option value="other">我的地址不在上述范围内</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: center;">
                    <button onclick="processCartOrder(currentOrderData)" 
                            style="background: #6B8E7B; color: white; border: none; padding: 0.8rem 1.5rem; border-radius: 25px; cursor: pointer; font-weight: bold;">
                        📱 确认订购
                    </button>
                    <button onclick="closeCartAddressModal()" 
                            style="background: #ccc; color: #333; border: none; padding: 0.8rem 1.5rem; border-radius: 25px; cursor: pointer;">
                        取消
                    </button>
                </div>
                
                <button onclick="closeCartAddressModal()" style="
                    position: absolute;
                    top: 15px;
                    right: 15px;
                    background: none;
                    border: none;
                    font-size: 1.5rem;
                    cursor: pointer;
                    color: #999;
                ">✕</button>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // 点击背景关闭
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeCartAddressModal();
                }
            });
        }
        
        // 处理购物车订单
        function processCartOrder(orderData) {
            const addressSelect = document.getElementById('cartAddressSelect');
            const selectedAddress = addressSelect.value;
            const selectedText = addressSelect.options[addressSelect.selectedIndex].text;
            
            if (!selectedAddress) {
                alert('请选择您的配送地址');
                return;
            }
            
            if (selectedAddress === 'other') {
                alert('很抱歉，您的地址暂时不在我们的配送范围内。\n\n我们目前只服务：\n• West Terra @ Bukit Batok (Block 447-453)\n• Le Quest公寓\n\n感谢您的理解！');
                return;
            }
            
            closeCartAddressModal();
            
            // 创建完整订单数据并跳转到支付选择
            const completeOrderData = {
                platform: 'whatsapp', // 购物车默认WhatsApp
                orderItems: orderData.orderItems,
                totalPrice: orderData.totalPrice,
                totalQuantity: orderData.totalQuantity,
                address: selectedText,
                isCart: true
            };
            
            showPaymentSelection(completeOrderData);
        }
        
        // 关闭购物车地址验证模态框
        function closeCartAddressModal() {
            const modal = document.querySelector('div[style*="position: fixed"][style*="z-index: 10000"]');
            if (modal) {
                modal.remove();
            }
        }
        
        // ==================== 支付方式选择系统 ====================
        
        // 显示支付方式选择
        function showPaymentSelection(orderData) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                backdrop-filter: blur(5px);
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                padding: 2rem;
                border-radius: 20px;
                max-width: 500px;
                width: 90%;
                text-align: center;
                box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                position: relative;
                max-height: 80vh;
                overflow-y: auto;
            `;
            
            // 生成订单摘要
            let orderSummary = '';
            if (orderData.isCart) {
                orderSummary = `
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 10px; margin-bottom: 1.5rem; text-align: left;">
                        <h4 style="color: #333; margin-bottom: 0.5rem;">📋 订单详情：</h4>
                        <div style="font-size: 0.9rem; line-height: 1.6;">
                            ${orderData.orderItems.replace(/\n/g, '<br>')}
                        </div>
                        <hr style="margin: 1rem 0; border: none; border-top: 1px solid #ddd;">
                        <div style="font-weight: bold; color: var(--accent-color);">
                            💰 总计：${orderData.totalQuantity}件商品，S$${orderData.totalPrice.toFixed(2)}
                        </div>
                    </div>
                `;
            } else {
                orderSummary = `
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 10px; margin-bottom: 1.5rem;">
                        <h4 style="color: #333; margin-bottom: 0.5rem;">📋 订单详情：</h4>
                        <div style="font-weight: bold; color: var(--accent-color);">
                            ${orderData.productName} - ${orderData.productPrice}
                        </div>
                    </div>
                `;
            }
            
            content.innerHTML = `
                <h3 style="color: #6B8E7B; margin-bottom: 1rem;">💳 选择支付方式</h3>
                
                ${orderSummary}
                
                <div style="background: #e8f5e8; padding: 1rem; border-radius: 10px; margin-bottom: 1.5rem; text-align: left;">
                    <div style="color: #6B8E7B; font-weight: bold; margin-bottom: 0.5rem;">
                        📍 配送地址：${orderData.address}
                    </div>
                    <div style="color: #E76F51; font-size: 0.9rem;">
                        🚚 免费配送 | ⏰ 30-60分钟送达
                    </div>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="color: #333; margin-bottom: 1rem;">请选择支付方式：</h4>
                    
                    <div style="display: grid; gap: 1rem; margin-bottom: 1rem;">
                        <div class="payment-option" data-payment="paynow" style="border: 2px solid #ddd; border-radius: 10px; padding: 1rem; cursor: pointer; transition: all 0.3s ease;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 1.5rem;">🏦</span>
                                <div style="text-align: left; flex: 1;">
                                    <div style="font-weight: bold; color: #333;">PayNow</div>
                                    <div style="font-size: 0.9rem; color: #666;">新加坡本地即时转账</div>
                                </div>
                                <div style="color: #28a745; font-weight: bold;">推荐</div>
                            </div>
                        </div>
                        
                        <div class="payment-option" data-payment="wechat" style="border: 2px solid #ddd; border-radius: 10px; padding: 1rem; cursor: pointer; transition: all 0.3s ease;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 1.5rem;">💬</span>
                                <div style="text-align: left; flex: 1;">
                                    <div style="font-weight: bold; color: #333;">微信支付</div>
                                    <div style="font-size: 0.9rem; color: #666;">WeChat Pay 扫码支付</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="font-size: 0.9rem; color: #666; text-align: left;">
                        💡 <strong>支付说明：</strong><br>
                        • 选择支付方式后，我们会提供详细的支付信息<br>
                        • 确认收到您的支付后，立即安排配送<br>
                        • 如有疑问，欢迎WhatsApp联系我们
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1.5rem;">
                    <button id="confirmPaymentBtn" disabled style="background: #6B8E7B; color: white; border: none; padding: 0.8rem 1.5rem; border-radius: 25px; cursor: pointer; font-weight: bold; opacity: 0.5;">
                        确认支付方式
                    </button>
                    <button onclick="closePaymentModal()" style="background: #ccc; color: #333; border: none; padding: 0.8rem 1.5rem; border-radius: 25px; cursor: pointer;">
                        返回修改
                    </button>
                </div>
                
                <button onclick="closePaymentModal()" style="
                    position: absolute;
                    top: 15px;
                    right: 15px;
                    background: none;
                    border: none;
                    font-size: 1.5rem;
                    cursor: pointer;
                    color: #999;
                ">✕</button>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // 添加支付方式选择交互
            let selectedPayment = null;
            const paymentOptions = content.querySelectorAll('.payment-option');
            const confirmBtn = content.querySelector('#confirmPaymentBtn');
            
            paymentOptions.forEach(option => {
                option.addEventListener('click', function() {
                    // 移除所有选中状态
                    paymentOptions.forEach(opt => {
                        opt.style.borderColor = '#ddd';
                        opt.style.backgroundColor = 'white';
                    });
                    
                    // 设置当前选中
                    this.style.borderColor = '#6B8E7B';
                    this.style.backgroundColor = '#f0f8f0';
                    
                    selectedPayment = this.getAttribute('data-payment');
                    
                    // 启用确认按钮
                    confirmBtn.disabled = false;
                    confirmBtn.style.opacity = '1';
                    confirmBtn.style.cursor = 'pointer';
                });
            });
            
            // 确认按钮事件
            confirmBtn.addEventListener('click', function() {
                if (selectedPayment) {
                    closePaymentModal();
                    processPayment(orderData, selectedPayment);
                }
            });
            
            // 点击背景关闭
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closePaymentModal();
                }
            });
        }
        
        // 处理支付方式选择
        function processPayment(orderData, paymentMethod) {
            if (paymentMethod === 'paynow') {
                showPayNowDetails(orderData);
            } else if (paymentMethod === 'wechat') {
                showWeChatPayDetails(orderData);
            }
        }
        
        // 显示PayNow支付详情
        function showPayNowDetails(orderData) {
            // 存储订单数据到全局变量
            currentPaymentData = orderData;
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                backdrop-filter: blur(5px);
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                padding: 2rem;
                border-radius: 20px;
                max-width: 450px;
                width: 90%;
                text-align: center;
                box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                position: relative;
            `;
            
            const totalAmount = orderData.isCart ? orderData.totalPrice.toFixed(2) : parseFloat(orderData.productPrice.replace('S$', '')).toFixed(2);
            
            content.innerHTML = `
                <h3 style="color: #6B8E7B; margin-bottom: 1rem;">🏦 PayNow 支付详情</h3>
                
                <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 10px; margin-bottom: 1.5rem;">
                    <div style="font-size: 1.2rem; font-weight: bold; color: #E76F51; margin-bottom: 1rem;">
                        支付金额：S$${totalAmount}
                    </div>
                    
                    <div style="background: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <div style="font-weight: bold; margin-bottom: 0.5rem;">PayNow ID:</div>
                        <div style="font-size: 1.1rem; font-weight: bold; color: #666; background: #e9ecef; padding: 0.5rem; border-radius: 5px;">
                            [待确认]
                        </div>
                        <div style="font-size: 0.8rem; color: #666; margin-top: 0.5rem;">
                            💬 我们会在WhatsApp中提供具体的PayNow信息
                        </div>
                    </div>
                    
                    <div style="background: white; padding: 1rem; border-radius: 8px;">
                        <div style="font-weight: bold; margin-bottom: 0.5rem;">收款人姓名:</div>
                        <div style="font-size: 1rem; color: #666;">[待确认]</div>
                    </div>
                </div>
                
                <div style="background: #e8f5e8; padding: 1rem; border-radius: 10px; margin-bottom: 1.5rem; text-align: left;">
                    <h4 style="color: #6B8E7B; margin-bottom: 0.5rem;">📱 PayNow转账步骤：</h4>
                    <div style="font-size: 0.9rem; line-height: 1.6;">
                        1️⃣ 我们会在WhatsApp中提供具体PayNow信息<br>
                        2️⃣ 输入金额: <strong>S$${totalAmount}</strong><br>
                        3️⃣ 在备注中写: <strong>豆豆谷订购</strong><br>
                        4️⃣ 确认转账并截图
                    </div>
                </div>
                
                <div style="font-size: 0.9rem; color: #666; margin-bottom: 1.5rem;">
                    💡 点击下方按钮，我们会在WhatsApp中提供详细的PayNow信息
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: center;">
                    <button onclick="sendPayNowOrderToWhatsApp()" style="background: #25D366; color: white; border: none; padding: 0.8rem 1.5rem; border-radius: 25px; cursor: pointer; font-weight: bold;">
                        📱 发送订单到WhatsApp
                    </button>
                    <button onclick="closePaymentModal()" style="background: #ccc; color: #333; border: none; padding: 0.8rem 1.5rem; border-radius: 25px; cursor: pointer;">
                        关闭
                    </button>
                </div>
                
                <button onclick="closePaymentModal()" style="
                    position: absolute;
                    top: 15px;
                    right: 15px;
                    background: none;
                    border: none;
                    font-size: 1.5rem;
                    cursor: pointer;
                    color: #999;
                ">✕</button>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
        }
        
        // 显示微信支付详情
        function showWeChatPayDetails(orderData) {
            // 存储订单数据到全局变量
            currentPaymentData = orderData;
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                backdrop-filter: blur(5px);
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                padding: 2rem;
                border-radius: 20px;
                max-width: 450px;
                width: 90%;
                text-align: center;
                box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                position: relative;
            `;
            
            const totalAmount = orderData.isCart ? orderData.totalPrice.toFixed(2) : parseFloat(orderData.productPrice.replace('S$', '')).toFixed(2);
            
            content.innerHTML = `
                <h3 style="color: #6B8E7B; margin-bottom: 1rem;">💬 微信支付详情</h3>
                
                <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 10px; margin-bottom: 1.5rem;">
                    <div style="font-size: 1.2rem; font-weight: bold; color: #E76F51; margin-bottom: 1rem;">
                        支付金额：S$${totalAmount}
                    </div>
                    
                    <div style="margin: 1.5rem 0;">
                        <img src="images/wechat-qr.jpg" 
                             style="width: 180px; height: 180px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);"
                             onerror="this.style.display='none'; document.getElementById('wechat-pay-error').style.display='block';">
                        
                        <div id="wechat-pay-error" style="display: none; padding: 2rem; background: #f0f0f0; border-radius: 10px;">
                            <p style="color: #666; margin: 0;">📱 微信支付二维码加载中...</p>
                        </div>
                    </div>
                    
                    <div style="background: white; padding: 1rem; border-radius: 8px;">
                        <div style="font-weight: bold; margin-bottom: 0.5rem;">微信号:</div>
                        <div style="font-size: 1.1rem; font-weight: bold; color: #333;">18565651233</div>
                        <button onclick="copyWeChatNumber()" style="background: #07C160; color: white; border: none; padding: 0.5rem 1rem; border-radius: 20px; margin-top: 0.5rem; cursor: pointer; font-size: 0.9rem;">
                            📋 复制微信号
                        </button>
                    </div>
                </div>
                
                <div style="background: #e8f5e8; padding: 1rem; border-radius: 10px; margin-bottom: 1.5rem; text-align: left;">
                    <h4 style="color: #6B8E7B; margin-bottom: 0.5rem;">📱 微信支付步骤：</h4>
                    <div style="font-size: 0.9rem; line-height: 1.6;">
                        1️⃣ 扫描上方二维码添加微信好友<br>
                        2️⃣ 备注：<strong>豆豆谷支付</strong><br>
                        3️⃣ 通过微信转账: <strong>S$${totalAmount}</strong><br>
                        4️⃣ 或直接使用微信收款码支付<br>
                        5️⃣ 截图发送确认
                    </div>
                </div>
                
                <div style="font-size: 0.9rem; color: #666; margin-bottom: 1.5rem;">
                    💡 支付完成后，请将截图发送至WhatsApp确认订单
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: center;">
                    <button onclick="sendWeChatOrderToWhatsApp()" style="background: #25D366; color: white; border: none; padding: 0.8rem 1.5rem; border-radius: 25px; cursor: pointer; font-weight: bold;">
                        📱 发送订单到WhatsApp
                    </button>
                    <button onclick="closePaymentModal()" style="background: #ccc; color: #333; border: none; padding: 0.8rem 1.5rem; border-radius: 25px; cursor: pointer;">
                        关闭
                    </button>
                </div>
                
                <button onclick="closePaymentModal()" style="
                    position: absolute;
                    top: 15px;
                    right: 15px;
                    background: none;
                    border: none;
                    font-size: 1.5rem;
                    cursor: pointer;
                    color: #999;
                ">✕</button>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
        }
        
        // 发送PayNow订单到WhatsApp
        function sendPayNowOrderToWhatsApp() {
            console.log('PayNow按钮被点击'); // 调试日志
            
            if (!currentPaymentData) {
                alert('订单数据未准备好，请先选择支付方式。');
                return;
            }
            
            try {
                let message;
                
                if (currentPaymentData.isCart) {
                    message = `🌱【豆豆谷批量订购】你好！我想订购以下商品：

📋 订单详情：
${currentPaymentData.orderItems}

💰 订单总计：${currentPaymentData.totalQuantity}件商品，S$${currentPaymentData.totalPrice.toFixed(2)}
📍 配送地址：${currentPaymentData.address}
🚚 免费配送服务

💳 支付方式：PayNow
💰 支付金额：S$${currentPaymentData.totalPrice.toFixed(2)}

请提供PayNow转账信息，我完成转账后会截图确认。谢谢！`;
                } else {
                    message = `🌱【豆豆谷订购】你好！我想订购：${currentPaymentData.productName} ${currentPaymentData.productPrice}

📍 配送地址：${currentPaymentData.address}
🚚 免费配送服务

💳 支付方式：PayNow
💰 支付金额：S$${currentPaymentData.productPrice}

请提供PayNow转账信息，我完成转账后会截图确认。谢谢！`;
                }
                
                console.log('准备发送WhatsApp消息'); // 调试日志
                openWhatsAppChat(message);
                
                // 如果是购物车订购，清空购物车
                if (currentPaymentData.isCart) {
                    cart = [];
                    localStorage.setItem('doodleCart', JSON.stringify(cart));
                    updateCartDisplay();
                }
                
                closePaymentModal();
                showOrderSuccess();
            } catch (error) {
                console.error('发送订单失败:', error);
                alert('发送订单时出现错误，请重试。');
            }
        }
        
        // 发送微信支付订单到WhatsApp
        function sendWeChatOrderToWhatsApp() {
            let message;
            
            if (currentPaymentData.isCart) {
                message = `🌱【豆豆谷批量订购】你好！我想订购以下商品：

📋 订单详情：
${currentPaymentData.orderItems}

💰 订单总计：${currentPaymentData.totalQuantity}件商品，S$${currentPaymentData.totalPrice.toFixed(2)}
📍 配送地址：${currentPaymentData.address}
🚚 免费配送服务

💳 支付方式：微信支付
💰 支付金额：S$${currentPaymentData.totalPrice.toFixed(2)}
💬 微信号：18565651233

我将通过微信转账后截图确认。谢谢！`;
            } else {
                message = `🌱【豆豆谷订购】你好！我想订购：${currentPaymentData.productName} ${currentPaymentData.productPrice}

📍 配送地址：${currentPaymentData.address}
🚚 免费配送服务

💳 支付方式：微信支付
💰 支付金额：S$${currentPaymentData.productPrice}
💬 微信号：18565651233

我将通过微信转账后截图确认。谢谢！`;
            }
            
            openWhatsAppChat(message);
            
            // 如果是购物车订购，清空购物车
            if (currentPaymentData.isCart) {
                cart = [];
                localStorage.setItem('doodleCart', JSON.stringify(cart));
                updateCartDisplay();
            }
            
            closePaymentModal();
            showOrderSuccess();
        }
        
        // 关闭支付模态框
        function closePaymentModal() {
            const modal = document.querySelector('div[style*="position: fixed"][style*="z-index: 10000"]');
            if (modal) {
                modal.remove();
            }
        }
        
        // 显示订单提交成功
        function showOrderSuccess() {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: var(--primary-color);
                color: white;
                padding: 2rem;
                border-radius: 15px;
                box-shadow: 0 8px 25px rgba(0,0,0,0.3);
                z-index: 10001;
                text-align: center;
                min-width: 300px;
            `;
            
            toast.innerHTML = `
                <div style="font-size: 3rem; margin-bottom: 1rem;">✅</div>
                <h3 style="margin-bottom: 1rem;">订单提交成功！</h3>
                <p style="margin: 0; opacity: 0.9;">您的订单已发送到WhatsApp<br>请完成支付后截图确认</p>
            `;
            
            document.body.appendChild(toast);
            
            // 3秒后移除
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 3000);
        }

        // ==================== 原有功能保持不变 ====================
        
        // WhatsApp随机分配系统
        const whatsappNumbers = [
            '6591012399',  // 用户本人
            '6583009375'   // 合伙人
        ];

        // 配送区域定义
        const deliveryAreas = {
            westTerra: {
                name: 'West Terra @ Bukit Batok',
                blocks: ['447', '448', '449', '450', '451', '452', '453'],
                address: 'Bukit Batok West Avenue'
            },
            leQuest: {
                name: 'Le Quest公寓',
                address: 'Bukit Batok West Avenue 6'
            }
        };

        function getRandomWhatsApp() {
            const randomIndex = Math.floor(Math.random() * whatsappNumbers.length);
            return whatsappNumbers[randomIndex];
        }

        function openWhatsAppChat(message) {
            const selectedNumber = getRandomWhatsApp();
            const whatsappUrl = `https://wa.me/${selectedNumber}?text=${encodeURIComponent(message)}`;
            
            // 移动端兼容性处理
            if (/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                // 移动端直接跳转，避免window.open问题
                window.location.href = whatsappUrl;
            } else {
                // 桌面端使用新窗口
                window.open(whatsappUrl, '_blank');
            }
        }

        // 启动配送地址验证流程
        function startDeliveryVerification(platform, productName = '', productPrice = '') {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                backdrop-filter: blur(5px);
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                padding: 2rem;
                border-radius: 20px;
                max-width: 500px;
                width: 90%;
                text-align: center;
                box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                position: relative;
            `;
            
            content.innerHTML = `
                <h3 style="color: #6B8E7B; margin-bottom: 1.5rem;">🚚 配送地址验证</h3>
                
                <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 10px; margin-bottom: 1.5rem; text-align: left;">
                    <h4 style="color: #333; margin-bottom: 1rem;">✅ 免费配送区域：</h4>
                    <div style="margin-bottom: 1rem;">
                        <strong>🏠 West Terra @ Bukit Batok</strong><br>
                        <span style="color: #666;">Block 447, 448, 449, 450, 451, 452, 453</span><br>
                        <span style="color: #666;">Bukit Batok West Avenue 2/5</span>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <strong>🏢 Le Quest公寓</strong><br>
                        <span style="color: #666;">Bukit Batok West Avenue 6</span>
                    </div>
                    <div style="color: #E76F51; font-weight: bold;">
                        🚚 配送费用：完全免费<br>
                        ⏰ 配送时间：30-60分钟
                    </div>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #333;">请选择您的地址：</label>
                    <select id="addressSelect" style="width: 100%; padding: 0.8rem; border: 2px solid #6B8E7B; border-radius: 10px; font-size: 1rem;">
                        <option value="">请选择您的具体地址...</option>
                        <optgroup label="🏠 West Terra @ Bukit Batok">
                            <option value="447">Block 447 Bukit Batok West Avenue</option>
                            <option value="448">Block 448 Bukit Batok West Avenue</option>
                            <option value="449">Block 449 Bukit Batok West Avenue</option>
                            <option value="450">Block 450 Bukit Batok West Avenue</option>
                            <option value="451">Block 451 Bukit Batok West Avenue</option>
                            <option value="452">Block 452 Bukit Batok West Avenue</option>
                            <option value="453">Block 453 Bukit Batok West Avenue</option>
                        </optgroup>
                        <optgroup label="🏢 Le Quest公寓">
                            <option value="lequest">Le Quest, Bukit Batok West Avenue 6</option>
                        </optgroup>
                        <option value="other">我的地址不在上述范围内</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: center;">
                    <button onclick="processAddressSelection('${platform}', '${productName}', '${productPrice}')" 
                            style="background: #6B8E7B; color: white; border: none; padding: 0.8rem 1.5rem; border-radius: 25px; cursor: pointer; font-weight: bold;">
                        确认订购
                    </button>
                    <button onclick="closeAddressModal()" 
                            style="background: #ccc; color: #333; border: none; padding: 0.8rem 1.5rem; border-radius: 25px; cursor: pointer;">
                        取消
                    </button>
                </div>
                
                <button onclick="closeAddressModal()" style="
                    position: absolute;
                    top: 15px;
                    right: 15px;
                    background: none;
                    border: none;
                    font-size: 1.5rem;
                    cursor: pointer;
                    color: #999;
                ">✕</button>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // 点击背景关闭
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeAddressModal();
                }
            });
        }

        // 处理地址选择
        function processAddressSelection(platform, productName, productPrice) {
            const addressSelect = document.getElementById('addressSelect');
            const selectedAddress = addressSelect.value;
            const selectedText = addressSelect.options[addressSelect.selectedIndex].text;
            
            if (!selectedAddress) {
                alert('请选择您的配送地址');
                return;
            }
            
            if (selectedAddress === 'other') {
                alert('很抱歉，您的地址暂时不在我们的配送范围内。\n\n我们目前只服务：\n• West Terra @ Bukit Batok (Block 447-453)\n• Le Quest公寓\n\n感谢您的理解！');
                return;
            }
            
            closeAddressModal();
            
            // 创建订单数据并跳转到支付选择
            const orderData = {
                platform: platform,
                productName: productName,
                productPrice: productPrice,
                address: selectedText,
                isCart: false
            };
            
            showPaymentSelection(orderData);
        }

        // 关闭地址验证模态框
        function closeAddressModal() {
            const modal = document.querySelector('div[style*="position: fixed"][style*="z-index: 10000"]');
            if (modal) {
                modal.remove();
            }
        }

        function showWeChatInfo() {
            // 创建一个更美观的弹窗
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                backdrop-filter: blur(5px);
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                padding: 2rem;
                border-radius: 20px;
                max-width: 400px;
                width: 90%;
                text-align: center;
                box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                position: relative;
            `;
            
            content.innerHTML = `
                <h3 style="color: #6B8E7B; margin-bottom: 1rem;">💬 微信咨询 - 豆豆谷</h3>
                
                <div style="margin: 1.5rem 0;">
                    <img src="images/wechat-qr.jpg" 
                         style="width: 200px; height: 200px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);"
                         onerror="this.style.display='none'; document.getElementById('qr-error').style.display='block';">
                    
                    <div id="qr-error" style="display: none; padding: 2rem; background: #f0f0f0; border-radius: 10px; margin: 1rem 0;">
                        <p style="color: #666; margin: 0;">📱 微信二维码加载中...</p>
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 1rem; border-radius: 10px; margin: 1rem 0;">
                    <p style="margin: 0; color: #333;"><strong>📱 微信号：18565651233</strong></p>
                    <button onclick="copyWeChatNumber()" style="
                        background: #07C160;
                        color: white;
                        border: none;
                        padding: 0.5rem 1rem;
                        border-radius: 20px;
                        margin-top: 0.5rem;
                        cursor: pointer;
                        font-size: 0.9rem;
                    ">📋 复制微信号</button>
                </div>
                
                <div style="font-size: 0.9rem; color: #666; text-align: left;">
                    <p><strong>添加方式：</strong></p>
                    <p>1️⃣ 扫描上方二维码</p>
                    <p>2️⃣ 手动搜索微信号：18565651233</p>
                    <p style="color: #E76F51;"><strong>📝 添加时请备注：豆豆谷咨询</strong></p>
                    
                    <hr style="margin: 1rem 0; border: none; border-top: 1px solid #eee;">
                    
                    <p>⏰ <strong>微信回复时间：</strong></p>
                    <p>• 工作日：晚上统一回复</p>
                    <p>• 周末：上午/下午集中回复</p>
                    <p>🔥 急需订购建议使用WhatsApp（即时回复）</p>
                    
                    <div style="background: #e8f5e8; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                        <p style="margin: 0; color: #6B8E7B; font-weight: bold;">🚚 免费配送服务</p>
                        <p style="margin: 0.5rem 0 0 0; font-size: 0.85rem;">West Terra @ Bukit Batok (Block 447-453) & Le Quest公寓</p>
                    </div>
                </div>
                
                <button onclick="closeWeChatModal()" style="
                    position: absolute;
                    top: 15px;
                    right: 15px;
                    background: none;
                    border: none;
                    font-size: 1.5rem;
                    cursor: pointer;
                    color: #999;
                ">✕</button>
                
                <button onclick="closeWeChatModal()" style="
                    background: #6B8E7B;
                    color: white;
                    border: none;
                    padding: 0.8rem 2rem;
                    border-radius: 25px;
                    margin-top: 1rem;
                    cursor: pointer;
                    font-weight: bold;
                ">知道了</button>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            // 点击背景关闭
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeWeChatModal();
                }
            });
        }

        function copyWeChatNumber() {
            if (navigator.clipboard) {
                navigator.clipboard.writeText('18565651233').then(() => {
                    alert('✅ 微信号已复制到剪贴板：18565651233');
                });
            } else {
                // 降级方案
                const textArea = document.createElement('textarea');
                textArea.value = '18565651233';
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('✅ 微信号已复制：18565651233');
            }
        }

        function closeWeChatModal() {
            const modal = document.querySelector('div[style*="position: fixed"][style*="z-index: 10000"]');
            if (modal) {
                modal.remove();
            }
        }

        // 产品定制选项功能
        let signatureOptions = {
            // 红粉豆语
            'homeSignature': {
                size: null,
                temperature: null,
                sugar: null,
                price: 7.80,
                name: '红粉豆语'
            },
            'signature': {
                size: null, 
                temperature: null,
                sugar: null,
                price: 7.80,
                name: '红粉豆语'
            },
            // 桂花双豆奶
            'homeGuihua': {
                size: null,
                temperature: null,
                sugar: null,
                price: 7.20,
                name: '桂花双豆奶'
            },
            'guihua': {
                size: null,
                temperature: null,
                sugar: null,
                price: 7.20,
                name: '桂花双豆奶'
            },
            // 茉莉双豆语
            'homeMoli': {
                size: null,
                temperature: null,
                sugar: null,
                price: 6.80,
                name: '茉莉双豆语'
            },
            'moli': {
                size: null,
                temperature: null,
                sugar: null,
                price: 6.80,
                name: '茉莉双豆语'
            },
            // 洛神四宝饮
            'homeLuoshen': {
                size: null,
                temperature: null,
                sugar: null,
                price: 8.50,
                name: '洛神四宝饮'
            },
            'luoshen': {
                size: null,
                temperature: null,
                sugar: null,
                price: 8.50,
                name: '洛神四宝饮'
            }
        };

        // 选择杯型
        function selectSize(productId, size, price) {
            const clickedButton = event.target;
            const isCurrentlyActive = clickedButton.classList.contains('active');
            
            // 获取产品的初始价格映射
            const defaultPrices = {
                'homeSignature': 7.80, 'signature': 7.80,
                'homeGuihua': 7.20, 'guihua': 7.20,
                'homeMoli': 6.80, 'moli': 6.80,
                'homeLuoshen': 8.50, 'luoshen': 8.50
            };
            
            // 如果点击的是已选中的选项，取消选择
            if (isCurrentlyActive) {
                clickedButton.classList.remove('active');
                signatureOptions[productId].size = null;
                signatureOptions[productId].price = defaultPrices[productId]; // 使用对应产品的默认价格
                updatePrice(productId);
                return;
            }
            
            // 选择新选项
            signatureOptions[productId].size = size;
            signatureOptions[productId].price = price;
            
            // 更新UI
            const sizeButtons = document.querySelectorAll(`[onclick*="selectSize('${productId}"]`);
            sizeButtons.forEach(btn => btn.classList.remove('active'));
            clickedButton.classList.add('active');
            
            // 更新价格显示
            updatePrice(productId);
        }

        // 选择温度
        function selectTemperature(productId, temperature) {
            const clickedButton = event.target;
            const isCurrentlyActive = clickedButton.classList.contains('active');
            
            // 如果点击的是已选中的选项，取消选择
            if (isCurrentlyActive) {
                clickedButton.classList.remove('active');
                signatureOptions[productId].temperature = null;
                return;
            }
            
            // 选择新选项
            signatureOptions[productId].temperature = temperature;
            
            const tempButtons = document.querySelectorAll(`[onclick*="selectTemperature('${productId}"]`);
            tempButtons.forEach(btn => btn.classList.remove('active'));
            clickedButton.classList.add('active');
        }

        // 选择糖分
        function selectSugar(productId, sugar) {
            const clickedButton = event.target;
            const isCurrentlyActive = clickedButton.classList.contains('active');
            
            // 如果点击的是已选中的选项，取消选择
            if (isCurrentlyActive) {
                clickedButton.classList.remove('active');
                signatureOptions[productId].sugar = null;
                return;
            }
            
            // 选择新选项
            signatureOptions[productId].sugar = sugar;
            
            const sugarButtons = document.querySelectorAll(`[onclick*="selectSugar('${productId}"]`);
            sugarButtons.forEach(btn => btn.classList.remove('active'));
            clickedButton.classList.add('active');
        }

        // 更新价格显示
        function updatePrice(productId) {
            const priceElement = document.getElementById(productId + 'Price');
            if (priceElement) {
                priceElement.textContent = `S$${signatureOptions[productId].price.toFixed(2)}`;
            }
        }

        // 获取产品完整描述
        function getSignatureDescription(productId) {
            const options = signatureOptions[productId];
            const sizeText = options.size === 'large' ? '大杯' : (options.size === 'small' ? '小杯' : '标准杯');
            const tempText = options.temperature === 'hot' ? '热饮' : (options.temperature === 'cold' ? '冰饮' : '常温');
            const sugarText = options.sugar === 'none' ? '无糖' : (options.sugar === 'half' ? '半糖' : (options.sugar === 'standard' ? '标准糖' : '不加糖'));
            
            return `${options.name} (${sizeText}/${tempText}/${sugarText})`;
        }

        // 添加红粉豆语到购物车
        function addSignatureToCart(productId) {
            const quantityInput = document.getElementById(productId + 'Quantity');
            const quantity = parseInt(quantityInput.value);
            const options = signatureOptions[productId];
            
            const productName = getSignatureDescription(productId);
            const price = `S$${options.price.toFixed(2)}`;
            
            addToCart(productName, price, '🌹', quantityInput.id);
        }

        // 直接订购红粉豆语
        function orderSignatureProduct(productId) {
            const options = signatureOptions[productId];
            const productName = getSignatureDescription(productId);
            const price = `S$${options.price.toFixed(2)}`;
            
            startDeliveryVerification('whatsapp', productName, price);
        }

        document.addEventListener('DOMContentLoaded', function() {
            // 初始化购物车
            initCart();
            
            // 滚动动画
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('fade-in');
                    }
                });
            });

            document.querySelectorAll('.product-card, .card').forEach(el => {
                observer.observe(el);
            });

            // 绑定传统WhatsApp按钮点击事件（如果还有的话）
            document.querySelectorAll('.whatsapp-btn[data-message]').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    const message = this.getAttribute('data-message');
                    openWhatsAppChat(message);
                });
            });
        });
    </script>
</body>
</html> 